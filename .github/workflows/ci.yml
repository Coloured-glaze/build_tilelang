name: Manual Build Wheel Package

on:
  workflow_dispatch:
    inputs:
      version:
        description: '自定义版本：若为 commit、tag、version 则自动获取'
        default: 'commit'
        required: true
        type: string
      python_version:
        description: 'Python version (支持多值，用分号分隔)'
        default: '3.12'
        required: true
        type: string
      torch_version:
        description: 'PyTorch version (支持多值，用分号分隔)'
        default: '2.8.0'
        required: true
        type: string
      cuda_version:
        description: 'CUDA version (支持多值，用分号分隔)'
        default: '12.8.1'
        required: true
        type: string
      os_version:
        description: 'OS version: ubuntu-latest, ubuntu-24.04, ubuntu-22.04'
        default: 'ubuntu-22.04'
        required: true
        type: string
      upload_artifact:
        description: 'Upload artifact: 0 or 1'
        required: true
        type: choice
        options:
          - '1'
          - '0'
        default: '1'
      release:
        description: 'Create release: 0 or 1'
        required: true
        type: choice
        options:
          - '1'
          - '0'
        default: '0'
      addl_info:
        description: 'Additional information (附加标识)'
        default: ''
        required: false
        type: string
      repository:
        description: 'Optional: Repository to checkout (e.g. tile-ai/tilelang). Uses current repo if not provided.'
        required: false
        type: string
        default: 'tile-ai/tilelang'

permissions:
  contents: write

jobs:
  set_matrix:
    name: Generate Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set Matrix
        id: set-matrix
        run: |
          import os
          import json

          py_versions = os.getenv("PYTHON_VERSION", "").split(";")
          torch_versions = os.getenv("TORCH_VERSION", "").split(";")
          cuda_versions = os.getenv("CUDA_VERSION", "").split(";")
          os_versions = os.getenv("OS_VERSION", "").split(";")

          include = []
          for os_ver in os_versions:
            for py in py_versions:
              for th in torch_versions:
                for cu in cuda_versions:
                  include.append({
                    "os_version": os_ver.strip(),
                    "python_ver": py.strip(),
                    "torch_ver": th.strip(),
                    "cuda_ver": cu.strip(),
                    "swap_size": "1"
                  })

          matrix = { "include": include }
          with open(os.getenv('GITHUB_OUTPUT'), 'a') as f:
            f.write(f"matrix={json.dumps(matrix)}\n")

          print("Generated matrix:", matrix)
        shell: python
        env:
          PYTHON_VERSION: ${{ inputs.python_version }}
          TORCH_VERSION: ${{ inputs.torch_version }}
          CUDA_VERSION: ${{ inputs.cuda_version }}
          OS_VERSION: ${{ inputs.os_version }}

  build_wheel:
    name: ${{ matrix.os_version }}-py${{ matrix.python_ver }}-th${{ matrix.torch_ver }}-cu${{ matrix.cuda_ver }}
    needs: set_matrix
    runs-on: ${{ matrix.os_version }}
    strategy:
      matrix: ${{ fromJSON(needs.set_matrix.outputs.matrix) }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.3.0
        with:
          submodules: recursive 
          repository: ${{ inputs.repository }}
          fetch-depth: 0 
          fetch-tags: true 

      - name: Verify Submodules
        run: |
          git submodule init
          git submodule update --recursive

          cd 3rdparty/tvm
          git fetch --tags origin || true
          if ! git tag -l | grep -q .; then
            git tag v0.22.0
          fi
          cd ../..

      - name: Set TVM Version (Fallback)
        run: |
          echo "TVM_VERSION=0.22.0" >> $GITHUB_ENV

      - name: Determine Version
        id: determine_version
        run: |
          INPUT_VERSION="${{ inputs.version }}"
          case "$INPUT_VERSION" in
            commit)
              version="$(git rev-parse --short HEAD)"
              ;;
            tag)
              version="git-$(git describe --tags --abbrev=0)"
              ;;
            version)
              if [ -f VERSION ]; then
                version=$(cat VERSION)
              else
                version="$INPUT_VERSION"
              fi
              ;;
            *)
              version="$INPUT_VERSION"
              ;;
          esac
          echo "d_ver=$version" >> "$GITHUB_OUTPUT"

      - name: Setup Python ${{ matrix.python_ver }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python_ver }}

      - name: Setup Swap Space (Linux only)
        if: runner.os == 'Linux'
        uses: pierotofy/set-swap-space@v1.0
        with:
          swap-size-gb: ${{ matrix.swap_size }}

      - name: Set Environment Variables
        run: |
          MATRIX_CUDA_VERSION=$(echo '${{ matrix.cuda_ver }}' | awk -F. '{print $1$2}')
          MATRIX_TORCH_VERSION=$(echo '${{ matrix.torch_ver }}' | awk -F. '{print $1"."$2}')
          WHEEL_CUDA_VERSION=$(echo '${{ matrix.cuda_ver }}' | awk -F. '{print $1}')
          MATRIX_PYTHON_VERSION=$(echo '${{ matrix.python_ver }}' | awk -F. '{print $1$2}')

          # 根据 PyTorch 版本选择 CUDA 构建版本
          TORCH_CUDA_VERSION=$(python -c "
          import os
          ver = os.environ['MATRIX_TORCH_VERSION']
          mapping = {
              '2.1': '118' if int(os.environ['MATRIX_CUDA_VERSION']) < 120 else '121',
              '2.2': '121' if int(os.environ['MATRIX_CUDA_VERSION']) < 120 else '121',
              '2.3': '121' if int(os.environ['MATRIX_CUDA_VERSION']) < 120 else '121',
              '2.4': '124' if int(os.environ['MATRIX_CUDA_VERSION']) < 120 else '124',
              '2.5': '124' if int(os.environ['MATRIX_CUDA_VERSION']) < 120 else '124',
              '2.6': '126' if int(os.environ['MATRIX_CUDA_VERSION']) < 120 else '126',
              '2.7': '128' if int(os.environ['MATRIX_CUDA_VERSION']) < 120 else '128',
              '2.8': '128' if int(os.environ['MATRIX_CUDA_VERSION']) < 120 else '128',
          }
          print(mapping.get(ver, '121'))  # 默认 fallback
          ")

          echo "MATRIX_CUDA_VERSION=$MATRIX_CUDA_VERSION" >> $GITHUB_ENV
          echo "MATRIX_TORCH_VERSION=$MATRIX_TORCH_VERSION" >> $GITHUB_ENV
          echo "WHEEL_CUDA_VERSION=$WHEEL_CUDA_VERSION" >> $GITHUB_ENV
          echo "MATRIX_PYTHON_VERSION=$MATRIX_PYTHON_VERSION" >> $GITHUB_ENV
          echo "TORCH_CUDA_VERSION=$TORCH_CUDA_VERSION" >> $GITHUB_ENV

      - name: Print Build Info
        run: |
          echo "Build Tag: ${{ steps.determine_version.outputs.d_ver }}-py${{ matrix.python_ver }}-th${{ matrix.torch_ver }}-cu${{ matrix.cuda_ver }}-${{ inputs.os_version }}${{ inputs.addl_info }}"
          echo "CUDA Version (matrix): ${{ env.MATRIX_CUDA_VERSION }}"
          echo "Torch Version (major.minor): ${{ env.MATRIX_TORCH_VERSION }}"
          echo "Wheel CUDA Version: ${{ env.WHEEL_CUDA_VERSION }}"
          echo "Python Version (numeric): ${{ env.MATRIX_PYTHON_VERSION }}"
          echo "Torch CUDA Version: ${{ env.TORCH_CUDA_VERSION }}"
          free -m
          df -h

      - name: Free Disk Space (Linux only)
        if: runner.os == 'Linux'
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          echo "Free disk space after removing large packages:"
          df -h

      - name: Get PATH Folder Sizes with Python
        run: |
          python -c "
          import os
          import subprocess
          
          # 获取 PATH 环境变量
          path_dirs = os.environ.get('PATH', '').split(':')
          
          print('PATH directories and their sizes:')
          print(path_dirs)
          print('=' * 60)
          
          total_size = 0
          for path_dir in path_dirs:
              if os.path.exists(path_dir) and os.path.isdir(path_dir):
                  try:
                      # 使用 du 命令获取文件夹大小
                      result = subprocess.run(['du', '-sh', path_dir], capture_output=True, text=True)
                      if result.returncode == 0:
                          size_info = result.stdout.strip().split('\t')[0]
                          print(f'{size_info:>8}  {path_dir}')
                          
                          # 解析大小（转换为字节用于总计）
                          if 'G' in size_info:
                              size_bytes = float(size_info.replace('G', '')) * 1024 * 1024 * 1024
                          elif 'M' in size_info:
                              size_bytes = float(size_info.replace('M', '')) * 1024 * 1024
                          elif 'K' in size_info:
                              size_bytes = float(size_info.replace('K', '')) * 1024
                          else:
                              size_bytes = float(size_info)
                          total_size += size_bytes
                      else:
                          print(f'Error getting size for: {path_dir}')
                  except Exception as e:
                      print(f'Error processing {path_dir}: {e}')
              else:
                  print(f'Missing or not a directory: {path_dir}')
          
          # 显示总计大小
          print('=' * 60)
          if total_size >= 1024 * 1024 * 1024:
              total_gb = total_size / (1024 * 1024 * 1024)
              print(f'Total PATH size: {total_gb:.2f} GB')
          elif total_size >= 1024 * 1024:
              total_mb = total_size / (1024 * 1024)
              print(f'Total PATH size: {total_mb:.2f} MB')
          elif total_size >= 1024:
              total_kb = total_size / 1024
              print(f'Total PATH size: {total_kb:.2f} KB')
          else:
              print(f'Total PATH size: {total_size:.0f} bytes')
          
          # 显示 PATH 中的目录数量
          valid_dirs = [d for d in path_dirs if os.path.exists(d) and os.path.isdir(d)]
          print(f'Number of valid PATH directories: {len(valid_dirs)}')
          print(f'Total PATH entries: {len(path_dirs)}')
          "

      - name: Build Wheel with cibuildwheel
        uses: pypa/cibuildwheel@v3.1.1
        env:
          CIBW_DEBUG_TRACEBACK: 1
          CIBW_BUILD_VERBOSITY: 3
          CIBW_MANYLINUX_X86_64_IMAGE: "manylinux_2_28"
          CIBW_BUILD: "cp${{ env.MATRIX_PYTHON_VERSION }}-manylinux_x86_64"
          CIBW_SKIP: "cp${{ env.MATRIX_PYTHON_VERSION }}-win* cp${{ env.MATRIX_PYTHON_VERSION }}-musl* cp${{ env.MATRIX_PYTHON_VERSION }}-macosx*"
          CIBW_ENVIRONMENT_PASS_LINUX: "MATRIX_CUDA_VERSION MATRIX_TORCH_VERSION WHEEL_CUDA_VERSION MATRIX_PYTHON_VERSION TORCH_CUDA_VERSION"
          CIBW_ENVIRONMENT: "MAX_JOBS=2"
          CIBW_BUILD_FRONTEND: "pip"
          CIBW_BEFORE_ALL: |
            set -x
            # Check environment variables
            echo "========Checking environment variables========"
            echo "MATRIX_CUDA_VERSION=${MATRIX_CUDA_VERSION}"
            echo "MATRIX_TORCH_VERSION=${MATRIX_TORCH_VERSION}"
            echo "WHEEL_CUDA_VERSION=${WHEEL_CUDA_VERSION}"
            echo "MATRIX_PYTHON_VERSION=${MATRIX_PYTHON_VERSION}"
            echo "TORCH_CUDA_VERSION=${TORCH_CUDA_VERSION}"
            echo "MAX_JOBS=${MAX_JOBS}"
            echo "========Checking environment variables========"
            # Install CUDA toolkit
            dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel8/x86_64/cuda-rhel8.repo
            dnf clean all
            RETRIES=5
            COUNT=0
            # install full cuda-toolkit
            until dnf -y install cuda-toolkit-${{ matrix.cuda_ver }}; do
              if [[ $COUNT -ge $RETRIES ]]; then
                echo "Failed after $RETRIES attempts, aborting."
                exit 1
              fi
              COUNT=$((COUNT+1))
              echo "Retrying CUDA installation($COUNT/$RETRIES)..."
              sleep 10
            done
            ls -al /usr/local
            export PATH=$PATH:/usr/local/cuda/bin
            nvcc --version
          CIBW_BEFORE_BUILD: |
            # Install PyTorch ${{ matrix.torch_ver }}+cu${{ env.TORCH_CUDA_VERSION }}
            pip install --upgrade pip

            # With python 3.13 and torch 2.5.1, unless we update typing-extensions, we get error
            pip install typing-extensions==4.12.2
            
            pip install --no-cache-dir torch==${{ matrix.torch_ver }} --index-url https://download.pytorch.org/whl/cu${TORCH_CUDA_VERSION}
            
            # Install build dependencies
            pip install 'numpy<2.0'
            pip install ninja packaging wheel setuptools==75.8.0 cmake==3.28 Cython build
            
            # Install project specific requirements
            pip install --no-cache-dir -r requirements-build.txt
            
            export PATH=/usr/local/cuda/bin:/usr/local/cuda/lib64:/usr/local/nvidia/bin:/usr/local/nvidia/lib64:$PATH
            export LD_LIBRARY_PATH=/usr/local/nvidia/lib64:/usr/local/cuda/lib64:$LD_LIBRARY_PATH
            nvcc --version
            python --version
            python -c "import torch; print('PyTorch:', torch.__version__)"
            python -c "import torch; print('CUDA:', torch.version.cuda)"
            python -c "from torch.utils import cpp_extension; print (cpp_extension.CUDA_HOME)"
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: |
            auditwheel repair --exclude 'libcuda.so*' --exclude 'libtorch.so*' --exclude 'libc10.so*' --exclude 'libtorch_python.so*' --exclude 'libc10_cuda.so*' --exclude 'libtorch_cuda.so*' --exclude 'libtorch_cpu.so*' --exclude 'libcudart.so.*' -w {dest_dir} {wheel}
        with:
          output-dir: dist

      - name: List built wheels
        if: ${{ always() }}
        run: |
          ls -lh dist/

      - name: Upload Artifact
        if: ${{ inputs.upload_artifact == '1' }}
        uses: actions/upload-artifact@v4.4.0
        with:
          name: ${{ steps.determine_version.outputs.d_ver }}-py${{ matrix.python_ver }}-th${{ matrix.torch_ver }}-cu${{ matrix.cuda_ver }}-${{ inputs.os_version }}${{ inputs.addl_info }}-${{ github.run_id }}
          path: dist/*.whl
          retention-days: 30

      - name: Create Release
        if: ${{ inputs.release == '1' }}
        uses: softprops/action-gh-release@v2.3.3
        with:
          tag_name: ${{ steps.determine_version.outputs.d_ver }}-py${{ matrix.python_ver }}-th${{ matrix.torch_ver }}-cu${{ matrix.cuda_ver }}-${{ inputs.os_version }}${{ inputs.addl_info }}
          files: dist/*.whl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}